<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="001-create-platforms-table" author="system">
        <createTable tableName="platforms">
            <column name="code" type="TEXT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="TEXT" defaultValue="active">
                <constraints nullable="false"/>
            </column>
            <column name="test_endpoint" type="TEXT"/>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMPTZ" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addCheckConstraint tableName="platforms" constraintName="platforms_status_check" 
                           checkCondition="status IN ('active', 'disabled')"/>
    </changeSet>

    <changeSet id="002-create-users-table" author="system">
        <createTable tableName="users">
            <column name="id" type="UUID" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="email" type="TEXT">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="display_name" type="TEXT"/>
            <column name="role" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addCheckConstraint tableName="users" constraintName="users_role_check" 
                           checkCondition="role IN ('MAIN_ADMIN', 'PLATFORM_ADMIN')"/>
    </changeSet>

    <changeSet id="003-create-user-platforms-table" author="system">
        <createTable tableName="user_platforms">
            <column name="user_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="platform_code" type="TEXT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addPrimaryKey tableName="user_platforms" columnNames="user_id,platform_code"/>
        
        <addForeignKeyConstraint baseTableName="user_platforms" baseColumnNames="user_id"
                                 constraintName="fk_user_platforms_user_id"
                                 referencedTableName="users" referencedColumnNames="id"
                                 onDelete="CASCADE"/>
        
        <addForeignKeyConstraint baseTableName="user_platforms" baseColumnNames="platform_code"
                                 constraintName="fk_user_platforms_platform_code"
                                 referencedTableName="platforms" referencedColumnNames="code"
                                 onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="004-create-cameras-table" author="system">
        <createTable tableName="cameras">
            <column name="id" type="UUID" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="public_id" type="TEXT">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="model" type="TEXT"/>
            <column name="status" type="TEXT" defaultValue="active">
                <constraints nullable="false"/>
            </column>
            <column name="target_platform_code" type="TEXT"/>
            <column name="redirect_enabled" type="BOOLEAN" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="is_test_device" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMPTZ" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addCheckConstraint tableName="cameras" constraintName="cameras_status_check" 
                           checkCondition="status IN ('active', 'disabled')"/>
        
        <addForeignKeyConstraint baseTableName="cameras" baseColumnNames="target_platform_code"
                                 constraintName="fk_cameras_target_platform"
                                 referencedTableName="platforms" referencedColumnNames="code"/>
    </changeSet>

    <changeSet id="005-create-import-jobs-table" author="system">
        <createTable tableName="import_jobs">
            <column name="id" type="UUID" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="uploader_user_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="file_name" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="total_rows" type="INT"/>
            <column name="success_rows" type="INT"/>
            <column name="failed_rows" type="INT"/>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="TEXT" defaultValue="done">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addCheckConstraint tableName="import_jobs" constraintName="import_jobs_status_check" 
                           checkCondition="status IN ('queued', 'processing', 'done', 'failed')"/>
        
        <addForeignKeyConstraint baseTableName="import_jobs" baseColumnNames="uploader_user_id"
                                 constraintName="fk_import_jobs_uploader_user"
                                 referencedTableName="users" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="006-create-import-job-errors-table" author="system">
        <createTable tableName="import_job_errors">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="job_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="row_no" type="INT"/>
            <column name="camera_id_in_file" type="TEXT"/>
            <column name="error_message" type="TEXT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="import_job_errors" baseColumnNames="job_id"
                                 constraintName="fk_import_job_errors_job_id"
                                 referencedTableName="import_jobs" referencedColumnNames="id"
                                 onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="007-create-audit-logs-table" author="system">
        <createTable tableName="audit_logs">
            <column name="id" type="UUID" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="UUID"/>
            <column name="action" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="resource_type" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="resource_id" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="before_data" type="JSONB"/>
            <column name="after_data" type="JSONB"/>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="audit_logs" baseColumnNames="user_id"
                                 constraintName="fk_audit_logs_user_id"
                                 referencedTableName="users" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="008-insert-default-platforms" author="system">
        <insert tableName="platforms">
            <column name="code" value="youtube"/>
            <column name="name" value="YouTube"/>
            <column name="status" value="active"/>
            <column name="test_endpoint" value="https://www.youtube.com"/>
        </insert>
        
        <insert tableName="platforms">
            <column name="code" value="twitch"/>
            <column name="name" value="Twitch"/>
            <column name="status" value="active"/>
            <column name="test_endpoint" value="https://www.twitch.tv"/>
        </insert>
        
        <insert tableName="platforms">
            <column name="code" value="facebook"/>
            <column name="name" value="Facebook Live"/>
            <column name="status" value="active"/>
            <column name="test_endpoint" value="https://www.facebook.com"/>
        </insert>
    </changeSet>

    <changeSet id="009-create-indexes" author="system">
        <createIndex tableName="cameras" indexName="idx_cameras_public_id">
            <column name="public_id"/>
        </createIndex>
        
        <createIndex tableName="cameras" indexName="idx_cameras_target_platform">
            <column name="target_platform_code"/>
        </createIndex>
        
        <createIndex tableName="cameras" indexName="idx_cameras_redirect_enabled">
            <column name="redirect_enabled"/>
        </createIndex>
        
        <createIndex tableName="user_platforms" indexName="idx_user_platforms_user_id">
            <column name="user_id"/>
        </createIndex>
        
        <createIndex tableName="user_platforms" indexName="idx_user_platforms_platform_code">
            <column name="platform_code"/>
        </createIndex>
        
        <createIndex tableName="audit_logs" indexName="idx_audit_logs_user_id">
            <column name="user_id"/>
        </createIndex>
        
        <createIndex tableName="audit_logs" indexName="idx_audit_logs_resource">
            <column name="resource_type"/>
            <column name="resource_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
